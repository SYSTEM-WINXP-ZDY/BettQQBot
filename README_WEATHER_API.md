# 使用免费API获取天气和位置信息

本次更新优化了免费API的使用方式，增加了更多备用API和错误处理机制。同时更新了图片功能，提供丰富的二次元图片资源。

## 主要修改

1. **天气查询功能**
   - 添加URL编码处理中文城市名，解决查询出错问题
   - 使用墨迹天气API获取天气数据（主要）
   - 使用天气API.com作为第一备用API
   - 增加和风天气免费API作为第二备用API
   - 三重保障确保天气查询功能正常工作

2. **位置获取功能**
   - 首先使用用户设置的自定义位置
   - 尝试通过NapCat API获取用户QQ设置的地区信息
   - 使用免费的IP-API.com服务获取IP位置信息
   - 备用方案使用ip.tool.lu网站爬取位置信息
   - 提供默认值（北京）以确保功能可用

3. **位置设置功能**
   - 添加URL编码处理中文城市名，解决验证失败问题
   - 使用墨迹天气API验证城市是否有效（主要）
   - 使用天气API.com作为备用城市验证方式（备用）
   - 保存用户自定义位置到本地文件

4. **二次元图片功能**
   - 使用国内免费二次元图片API，无需申请
   - 按90%女生、10%男生比例提供随机图片
   - 支持多种图片分类：女生、男生、风景、壁纸、萌宠等
   - 添加备用API确保服务稳定

## 修复问题

1. **解决中文编码问题**
   - 添加URL编码处理中文城市名（如"贵港"、"南宁"等）
   - 解决了查询某些城市失败的问题
   - 更全面的日志记录，方便排查问题

2. **增强服务可靠性**
   - 增加到三层备用API，确保服务可用性
   - 完善错误处理机制，提供更友好的错误提示
   - 如果城市名有误，建议尝试更详细的名称（如"广西贵港"）

## 依赖

依然需要以下Python库依赖：
- `aiohttp`：用于异步HTTP请求
- `json`：处理API返回的JSON数据
- `urllib.parse`：处理URL编码

## 使用方法

与之前相同，支持以下命令：
- `天气`：获取当前位置的天气信息
- `天气 城市名`：获取指定城市的天气信息
- `设置位置 城市名`：设置默认天气查询位置
- `图片`：获取随机二次元图片（90%女生、10%男生）
- `图片 女生/男生/风景/壁纸/萌宠`：获取指定类别的图片

## 注意事项

1. 免费API可能有请求频率限制，建议合理使用
2. 如果查询失败，可以尝试使用更详细的城市名称（如"广西贵港"而不是"贵港"）
3. 所有API调用都有适当的错误处理和备用方案

## 优势

1. 无需支付API使用费用
2. 三层API备份机制，大幅提高服务可靠性
3. 更全面的错误处理和日志记录
4. 提供友好的错误提示，改善用户体验
5. 丰富的二次元图片资源，满足不同需求 
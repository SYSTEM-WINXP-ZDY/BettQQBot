# 配置文件加密说明

本项目使用RSA-2048非对称加密来保护配置文件中的敏感信息，并提供了配置文件完整性检查功能。

## 加密方式

本系统提供几种加密方式：

1. **选择性加密**：只加密敏感字段（如API密钥、密码等）
2. **完全加密**：加密配置文件中的所有字符串值，并创建备份用于启动时检查完整性
3. **分段加密**：对于超长文本（如系统提示词），自动分成小段（每段约20个字符）分别加密，解决RSA加密长度限制问题

## 工作原理

### 选择性加密

1. 系统使用RSA-2048算法生成公钥和私钥对。
2. 公钥用于加密配置文件中的敏感信息，私钥用于解密。
3. 敏感字段（如`access_token`、`api_key`等）在配置文件中会被加密存储。
4. 加密的字段会以`ENC:`开头，后面跟着Base64编码的加密数据。
5. 程序启动时，会自动解密这些字段，但在日志中不会显示明文的敏感信息。

### 完全加密与完整性检查

1. 系统将配置文件中的所有字符串值进行加密。
2. 创建一个原始配置文件的备份（`.original`后缀）供修改使用。
3. 创建一个加密后的备份副本（`.backup.yaml`）用于启动时校验。
4. 程序启动时会自动比较主配置文件和备份副本，如发现不一致，程序会立即退出以防止潜在的安全风险。

### 分段加密

- 超长文本（超过200个字符）会自动使用分段加密
- 每段约20个字符，分别加密后以特殊格式存储
- 解密时会自动识别并组合这些段
- 解决了RSA对长文本的加密限制问题

## 使用方法

在Windows上使用：

```
encrypt_all_text.bat config.yaml
```

或使用Python直接运行：

```
python encrypt_all_text.py --force config.yaml config.encrypted.yaml
```

**分段加密功能**：
- 超长文本（超过200个字符）会自动使用分段加密
- 每段约20个字符，分别加密后以特殊格式存储
- 解密时会自动识别并组合这些段
- 解决了RSA对长文本的加密限制问题

完整性检查说明：
- 运行完全加密后，会创建一个加密的备份文件 `config.backup.yaml`
- 程序启动时会自动比较 `config.yaml` 和 `config.backup.yaml`
- 如果两个文件不一致，程序会拒绝启动

### 修改配置

**对于选择性加密**：
1. 编辑备份文件 `config.yaml.bak`
2. 重新运行加密脚本：`python src/utils/crypto.py config.yaml.bak config.yaml`

**对于完全加密**：
1. 编辑原始备份文件 `config.yaml.original`
2. 重新运行完全加密脚本：`encrypt_full_config.bat` 或 `.\encrypt_full_config.ps1`

## 故障排除

### 找不到Python

如果您遇到"No installed Python found!"错误，请检查：
1. 确认Python已正确安装
2. 确认Python已添加到系统PATH环境变量
3. 尝试运行`check_python.bat`脚本来诊断问题
4. 如果您确定Python已安装但脚本无法找到，请在脚本中使用Python的完整路径

### "Encryption failed"错误

如果遇到"Encryption failed"错误，可能有以下原因：
1. 配置文件中包含太长的字符串（例如system_prompt字段通常很长）
2. RSA加密算法有最大加密长度限制

解决方法：
1. 使用强制选项：`encrypt_all_text.py --force`
2. 现在工具已支持分段加密，可以自动处理超长文本

### 配置文件被锁定

如果使用了完全加密并启用了完整性检查，但需要修改配置：
1. 不要直接修改 `config.yaml`（这会导致程序拒绝启动）
2. 应该修改 `config.yaml.original` 文件，然后重新运行加密脚本
3. 如果丢失了原始文件，可以通过解密 `config.yaml` 来恢复

## 安全提示

1. 保持`keys`目录的安全，尤其是私钥文件。
2. 如果担心私钥泄露，可以删除`keys`目录，系统会重新生成密钥对，但这也意味着之前加密的配置将无法解密。
3. 定期备份 `config.yaml.original` 和密钥文件。
4. 完全加密提供了更高的安全性，但配置修改流程更为复杂。
5. 如果配置文件中包含非常长的文本（如系统提示词），可能会遇到加密限制，此时可以使用强制模式，这些字段将保持未加密状态。

## 实现细节

- 加密功能位于`src/utils/crypto.py`
- 配置加载逻辑位于`src/utils/config.py`
- 完整性检查在`main.py`中实现
- 使用Python的`cryptography`库实现RSA加密
- 系统会特殊处理超长字符串，对于超过1000字符的字段可能会保留原始值